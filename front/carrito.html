<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito de Compras</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>üõí Tu Carrito</h1>

    <!-- Bot√≥n para cerrar sesi√≥n -->
    <button onclick="cerrarSesion()" class="logout-btn">Cerrar sesi√≥n</button>

    <!-- Lista din√°mica de productos -->
    <div id="listaCarrito"></div>

    <!-- Total -->
    <h2 id="total"></h2>

    <h2>Formulario de Pedido</h2>
    <form id="pedidoForm">
      <input type="text" name="cliente" placeholder="Nombre completo" required><br>
      <input type="email" name="correo" placeholder="Correo electr√≥nico" required><br>
      <input type="text" name="direccion" placeholder="Direcci√≥n de env√≠o" required><br>
      <select name="metodoPago" required>
        <option value="">Seleccione m√©todo de pago</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="efectivo">Efectivo</option>
        <option value="transferencia">Transferencia</option>
      </select><br>
      <button type="submit">Confirmar Pedido</button>
    </form>

    <pre id="pedidoResultado" class="alerta"></pre>
  </div>

  <!-- ==================== L√≥gica del carrito ==================== -->
  <script>
  const API = "http://localhost:3000";
  const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  const lista = document.getElementById("listaCarrito");
  const totalHTML = document.getElementById("total");

  // ==================== Mostrar productos ====================
  if (carrito.length === 0) {
    lista.innerHTML = "<p>Tu carrito est√° vac√≠o üõí</p>";
  } else {
    let total = 0;
    carrito.forEach((p, index) => {
      const subtotal = p.valor * p.cantidad;
      total += subtotal;
      const item = document.createElement("div");
      item.className = "producto";
      item.innerHTML = `
        <img src="${p.img}" alt="${p.nombre}" width="100">
        <h3>${p.nombre}</h3>
        <p>Precio: $${p.valor.toLocaleString()} COP</p>
        <p>Cantidad: ${p.cantidad}</p>
        <p>Subtotal: $${subtotal.toLocaleString()} COP</p>
        <button onclick="eliminarDelCarrito(${index})">‚ùå Eliminar</button>
      `;
      lista.appendChild(item);
    });
    totalHTML.textContent = "üí∞ Total: $" + total.toLocaleString() + " COP";
  }

  // ==================== Eliminar producto ====================
  function eliminarDelCarrito(index) {
    carrito.splice(index, 1);
    localStorage.setItem("carrito", JSON.stringify(carrito));
    location.reload();
  }

  // ==================== Enviar pedido ====================
  document.getElementById("pedidoForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (carrito.length === 0) {
      document.getElementById("pedidoResultado").textContent = "‚ùå Tu carrito est√° vac√≠o.";
      return;
    }

    const data = Object.fromEntries(new FormData(e.target));
    const metodoPago = data.metodoPago;

    if (!["tarjeta","efectivo","transferencia"].includes(metodoPago)) {
      document.getElementById("pedidoResultado").textContent = "‚ùå M√©todo de pago inv√°lido.";
      return;
    }

    try {
      let resultados = [];

      for (const prod of carrito) {
        const res = await fetch(`${API}/pedidos`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token") // üîë Agregamos token
          },
          body: JSON.stringify({
            productoId: prod.id,
            cliente: data.cliente,
            correo: data.correo,
            direccion: data.direccion,
            cantidad: prod.cantidad,
            metodoPago
          })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || "Error al registrar pedido");
        resultados.push(result);
      }

      localStorage.removeItem("carrito");
      document.getElementById("pedidoResultado").textContent =
        "‚úÖ Todos los pedidos fueron registrados exitosamente.\n" + JSON.stringify(resultados, null, 2);

      // Opcional: redirigir despu√©s de unos segundos
      setTimeout(() => { window.location.href = "index.html"; }, 4000);

    } catch (err) {
      document.getElementById("pedidoResultado").textContent = "‚ùå " + err.message;
    }
  });
  </script>

  <!-- ==================== Verificaci√≥n de login ==================== -->
  <script src="js/auth.js"></script>
  <script>
    verificarLogin();
  </script>
</body>
</html>
